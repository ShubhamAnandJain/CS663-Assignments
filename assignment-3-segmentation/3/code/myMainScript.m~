%% Q3: Background blur

%%
% The Algorithm:
%%
% # Apply Mean Shift Segmentation (use code from the previous part) and knnsearch (with k=2) to get 2 segments.
% Then use the built-in function _bwareafilt_ to extract the largest contour. For both
% bird and the flower, the largest contour luckily turns out to be the
% actual foreground. In other cases, we will need manual intervention in
% this step.
% # Use Canny Edge detection (built-in MATLAB function) to get the boundary
% of the foreground.
% # Initialise a matrix (Same size as that of image) with all alphas where
% (i,j) entry denotes the minimum distance of the pixel from the foreground mask.
% Then iterate over all the boundary pixels. For each boundary
% pixel, iterate over the radius from 1 to alpha and find all pixels (i,j)
% such that their distance from current boundary pixel is between r-1 and r.
% Set matrix(i,j) to min(matrix(i,j), r). Set radius for all pixels in the foreground to 0.
% # Now, for disc blurring, iterate over all pixels in the image. If radius =
% 0 (foreground), do nothing. Otherwise, use the built-in MATLAB function
% fspecial(r, 'disk') to construct the disc filter and apply it to the
% current point.

%% Image of a flower
%  Gaussian kernel bandwidth for the color feature : 200
%  Gaussian kernel bandwidth for the spatial feature : 40
%  Number of Iterations : 30
clc
img = imread('../data/flower.jpg');
alpha = 20;
downsample_fac = 1;
I = imresize(img, downsample_fac);
tic;
% get mean shift segmentation result
% foregroundMask = myForegroundMask(double(I),80,60,30,200,0.1);
% foreground = bwareafilt(foregroundMask, 1);
% imwrite(foreground, '/Users/mithileshvaidya/Documents/Sem 7/DIP/CS663-Assignments/assignment-3-segmentation/3/results/flower_foreground.png');
foreground = imread('/Users/mithileshvaidya/Documents/Sem 7/DIP/CS663-Assignments/assignment-3-segmentation/3/results/flower_foreground.png');
only_f = img;
only_b = img;
for c = 1:3
    temp = only_f(:,:,c);
    temp(~logical(foreground)) = 0;
    only_f(:,:,c) = temp;
    temp = only_b(:,:,c);
    temp(logical(foreground)) = 0;
    only_b(:,:,c) = temp;    
end

subplot(1,4,1)
title("Original Image");
imshow(img)
subplot(1,4,2)
title("Mask");
imshow(foreground)
subplot(1,4,3)
title("Only Background");
imshow(only_b)
subplot(1,4,4)
title("Only Foreground");
imshow(only_f)

% find boundary of largest contour = foreground
bd = edge(foreground,'Canny');
[rows,cols] = find(bd);
boundary = [cols, rows];
% find radius map
% 0.2
radiusMask = myRadiusMap(I, boundary, round(alpha*0.2));
foreground = logical(foreground);
radiusMask(foreground) = 0;    
title("0.2*alpha");
imagesc(radiusMask./max(radiusMask));
colormap('jet');
axis off;
% 0.4
radiusMask = myRadiusMap(I, boundary, round(alpha*0.4));
foreground = logical(foreground);
radiusMask(foreground) = 0;    
title("0.4*alpha");
imagesc(radiusMask./max(radiusMask));
colormap('jet');
axis off;
% 0.6
radiusMask = myRadiusMap(I, boundary, round(alpha*0.6));
foreground = logical(foreground);
radiusMask(foreground) = 0;    
title("0.6*alpha");
imagesc(radiusMask./max(radiusMask));
colormap('jet');
axis off;
% 0.8
radiusMask = myRadiusMap(I, boundary, round(alpha*0.8));
foreground = logical(foreground);
radiusMask(foreground) = 0;    
title("0.8*alpha");
imagesc(radiusMask./max(radiusMask));
colormap('jet');
axis off;
% 1
radiusMask = myRadiusMap(I, boundary, alpha);
foreground = logical(foreground);
radiusMask(foreground) = 0;    
title("alpha");
imagesc(radiusMask./max(radiusMask));
colormap('jet');
axis off;

% blur
final = uint8(myDiscBlur(I, radiusMask, alpha));
title("Original Image");
imshow(I)

toc;

%% Image of a bird
%  Gaussian kernel bandwidth for the color feature : 40
%  Gaussian kernel bandwidth for the spatial feature : 30
%  Number of Iterations : 20
% clc
% img = imread('../data/bird.jpg');
% alpha = 40;
% downsample_fac = 0.25;
% I = imresize(img, downsample_fac);
% tic;
% % get mean shift segmentation result
% foregroundMask = myForegroundMask(double(I),30,40,30,200,0.1);
% foreground = bwareafilt(foregroundMask, 1);
% imwrite(foreground, '/Users/mithileshvaidya/Documents/Sem 7/DIP/CS663-Assignments/assignment-3-segmentation/3/results/bird_foreground.png');
% % foreground = imread('/Users/mithileshvaidya/Documents/Sem 7/DIP/CS663-Assignments/assignment-3-segmentation/3/results/bird_foreground.png');

% [radiusMask, final] = myPipeline(I, foreground, alpha);
% subplot(1, 3, 1)
% imshow(I)
% title("Original Image");
% subplot(1, 3, 2)
% imshow(radiusMask./max(radiusMask));
% title("Radius of blurring");
% subplot(1, 3, 3)
% imshow(final);
% title("Final Image");
% toc;